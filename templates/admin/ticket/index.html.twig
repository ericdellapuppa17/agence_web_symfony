{% extends 'base.html.twig' %}

{% block title %}Gestion des tickets{% endblock %}

{% block body %}
<div class="container mt-4">

    <h1 class="mb-4">Tickets en cours</h1>

    <a href="{{ path('admin_dashboard') }}" class="btn btn-secondary btn-sm mb-3">
        ← Retour à l'administration
    </a>


    <!-- Filtres -->
    <form method="get" class="row g-3">

        <div class="col-md-4">
            <label class="form-label">Filtrer par statut</label>
            <select name="statut" class="form-select">
                <option value="Tous">Tous</option>
                {% for s in statuts %}
                    <option value="{{ s.id }}" {{ statut == s.id ? 'selected' }}>
                        {{ s.libelle }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4">
            <label class="form-label">Filtrer par responsable</label>
            <select name="responsable" class="form-select">
                <option value="Tous">Tous</option>
                {% for r in responsables %}
                    <option value="{{ r.id }}" {{ responsable == r.id ? 'selected' }}>
                        {{ r.nom }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="col-md-4 d-flex align-items-end">
            <button class="btn btn-primary w-100">Filtrer</button>
        </div>

    </form>

    <hr>

    {# CAS 1: la table ticket est vide #}
    {% if totalTickets == 0 %}
        <div class="alert alertInfo mt-3">
            Aucun ticket en cours
        </div>

    {# CAS 2: la table ticket n'est pas vide mais aucun ne correspond à la sélection #}
    {% elseif tickets is empty %}
        <div class="alert alert-warning mt-3">
            Aucun ticket ne correspond aux filtres sélectionnés
        </div>

    {# CAS 3: Il y a des tickets correspondants aux filtres #}    
    {% else %}

        <table class="table table-striped align-middle">

            <thead>
                <tr>
                    <th>ID</th>
                    <th>Auteur</th>
                    <th>Catégorie</th>
                    <th>Description</th>
                    <th>Statut</th>
                    <th>Responsable</th>
                    <th class="text-nowrap">Ouvert le :</th>
                    <th class="text-nowrap">Fermé le :</th>
                    <th>Action</th>
                </tr>
            </thead>

            <tbody>
                {% for ticket in tickets %}
                    <tr>
                        <td>{{ ticket.id }}</td>
                        <td>{{ ticket.auteur }}</td>
                        <td>{{ ticket.categorie }}</td>
                        <td>{{ ticket.description }}</td>
                        <td>
                            {% set s = ticket.statut.libelle %}
                            <span class="badge
                                {% if s == 'Nouveau' %} bg-secondary
                                {% elseif s == 'Ouvert' %} bg-primary
                                {% elseif s == 'Résolu' %} bg-success
                                {% elseif s == 'Fermé' %} bg-dark
                                {% endif %}
                            ">
                                {{ s }}
                            </span>   
                        </td>
                        <td>
                            {% if ticket.responsable %}
                                {{ ticket.responsable.nom }}
                            {% else %}
                                <span class="text-muted">Aucun</span>
                            {% endif %}
                        </td>
                        <td>{{ ticket.dateOuverture|date('d/m/Y H:i') }}</td>
                        <td>
                            {% if ticket.dateCloture %}
                                {{ ticket.dateCloture|date('d/m/Y H:i') }}
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                        <td>
                            <a href="{{ path('admin_ticket_edit', {id: ticket.id}) }}" class="btn btn-sm btn-outline-primary">                               
                                Modifier
                            </a>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

    {% endif %}

</div>

{% endblock %}
